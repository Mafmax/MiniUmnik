!function a(r,o,d){function l(t,e){if(!o[t]){if(!r[t]){var s="function"==typeof require&&require;if(!e&&s)return s(t,!0);if(c)return c(t,!0);var i=new Error("Cannot find module '"+t+"'");throw i.code="MODULE_NOT_FOUND",i}var n=o[t]={exports:{}};r[t][0].call(n.exports,function(e){return l(r[t][1][e]||e)},n,n.exports,a,r,o,d)}return o[t].exports}for(var c="function"==typeof require&&require,e=0;e<d.length;e++)l(d[e]);return l}({1:[function(e,t,s){"use strict";var i={};t.exports={create:function(e,t,s){return this.destroy(i[e]),i[e]=new t(s)},destroy:function(e){e&&(e.clean&&e.clean(),e.undelegateEvents(),e.unbind(),e.remove())}}},{}],2:[function(e,t,s){"use strict";var i=e("./messagesPreviewView"),n=e("./messageCollection");$(function(){window.vent=window.vent||_.extend({},Backbone.Events),new i({el:$("[data-js=messagesPreview]"),collection:new n})})},{"./messageCollection":3,"./messagesPreviewView":6}],3:[function(e,t,s){"use strict";var i=e("./messageModel");t.exports=Backbone.Collection.extend({url:"/ajax/getUnreadMessages",model:i,state:new Backbone.Model({cnt:0}),initialize:function(){this.limit=5,this.on("add",this.cropTail.bind(this)),this.listenTo(window.vent,"socketEvents",function(e){var t=this;if("message"===e.type){var s=new Date,i=s.getHours(),n=(s.getMinutes()<10?"0":"")+s.getMinutes();if(userId===e.byUserId)return;this.add({readableDate:i+":"+n,byId:e.byUserId,orderTitle:e.orderTitle,order_id:e.orderId,text:e.message,name:e.name}),this.updateCount(e.newCountMessages)}"hasRead"===e.type&&this.fetch({reset:!0}).then(function(e){e.body.items.forEach(function(e){t.add({readableDate:e.readableDate,byId:e.byId,orderTitle:e.orderTitle,order_id:e.order_id,text:e.text,name:e.name})})})}.bind(this)),this.fetch()},parse:function(e){try{return this.state.set({cnt:e.body.cnt}),e.body.items.reverse()}catch(e){return console.log(e),[]}},clearMessages:function(){$.ajax({type:"post",url:"/ajax/clearNewMessages",success:function(){this.reset(),this.state.set({cnt:0})}.bind(this)})},updateCount:function(e){this.state.set({cnt:e})},cropTail:function(){if(this.length>this.limit){var e=this.first();e.trigger("destroy",e)}}})},{"./messageModel":4}],4:[function(e,t,s){"use strict";t.exports=Backbone.Model.extend({defaults:{authorId:null,byId:null,comment_id:null,orderTitle:null,order_id:null,readableDate:null,text:null,to_id:null,name:null}})},{}],5:[function(e,t,s){"use strict";var i=Twig.twig({data:e("./templates/messageTemplate.twig")}),n=e("./../_shared/vm");t.exports=Backbone.View.extend({className:"m-messagesPreview__listItem",initialize:function(){this.listenTo(this.model,"destroy",function(){n.destroy(this)}.bind(this))},render:function(){return this.$el.html(i.render(this.model.toJSON())),this.el}})},{"./../_shared/vm":1,"./templates/messageTemplate.twig":7}],6:[function(e,t,s){"use strict";var i=Twig.twig({data:e("./templates/messagesPreviewTemplate.twig")}),n=e("./../_shared/vm"),a=e("./messageView");t.exports=Backbone.View.extend({events:{click:"openReactChat","click [data-js=clearMessageList]":"clearMessageList"},initialize:function(){this.subViews=[],this.render(),this.listenTo(this.collection,"add",this.addMessage.bind(this)),this.listenTo(this.collection,"reset",this.removeMessages.bind(this)),this.listenTo(this.collection.state,"change:cnt",this.updateCount.bind(this))},render:function(){this.$el.html(i.render())},addMessage:function(e){var t=new a({model:e});this.subViews.push(t),this.$el.find("[data-js=messagesList]").prepend(t.render())},removeMessages:function(){_.each(this.subViews,function(e){n.destroy(e)}.bind(this)),this.subViews=[]},clearMessageList:function(){this.collection.clearMessages()},updateCount:function(e,t){this.$el.find("[data-js=messagesCount]").html(t||"")},openReactChat:function(e){try{window.__oneActiveOrderChat&&window.__newInterface&&(e.preventDefault(),window.__openReactChat())}catch(e){}}})},{"./../_shared/vm":1,"./messageView":5,"./templates/messagesPreviewTemplate.twig":8}],7:[function(e,t,s){t.exports='<a class="m-messagesPreview__link" href="/order/getoneorder/{{ order_id }}?openDialog={{ byId }}">\n    <div class="m-messagesPreview__name">{{ name }}</div>\n    <div class="m-messagesPreview__text">{{ isFile ? \'Файл\' : text }}</div>\n    <div class="m-messagesPreview__date">{{ readableDate }}</div>\n</a>'},{}],8:[function(e,t,s){t.exports='<a href="/home?scroll=message" class="m-messagesPreview__menuItem">\n    <div class="m-messagesPreview__count" data-js="messagesCount"></div>\n</a>\n<div class="m-messagesPreview__messages">\n    <div class="m-messagesPreview__list" data-js-listHeading="Новые сообщения" data-js="messagesList"></div>\n    <div class="m-messagesPreview__isEmpty">У вас нет новых сообщений</div>\n    <div class="m-messagesPreview__clear" data-js="clearMessageList">Очистить уведомления</div>\n</div>\n\n'},{}]},{},[2]);